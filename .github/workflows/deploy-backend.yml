name: Deploy backend

on:
  workflow_dispatch:   # ручной запуск
  workflow_call:       # позволяет вызывать через uses:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"

concurrency:
  group: deploy-backend
  cancel-in-progress: false

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ---------------- SSH KEY ----------------
      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Add server to known_hosts
        run: |
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      # ---------------- PRE-RSYNC BACKUP ----------------
      - name: Backup project on server
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" 'bash -s' <<'EOF'
          set -e
          PROJECT_ROOT="/srv/legal-ai"
          BACKUP_ROOT="$PROJECT_ROOT/backups"
          TIMESTAMP="$(date +%Y%m%d-%H%M%S)"

          mkdir -p "$BACKUP_ROOT"

          if [ -d "$PROJECT_ROOT" ]; then
            echo "[BACKUP] Создаю бэкап ${BACKUP_ROOT}/legal-ai_${TIMESTAMP}.tar.gz"
            tar -czf "${BACKUP_ROOT}/legal-ai_${TIMESTAMP}.tar.gz" \
              --exclude='./backups' \
              --exclude='./deploy_logs' \
              --exclude='./data' \
              -C /srv legal-ai || true
          else
            echo "[BACKUP] Каталог не найден, пропускаю."
          fi
EOF

      # ---------------- RSYNC ----------------
      - name: Rsync project to server
        run: |
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude "frontend/node_modules" \
            --exclude "data/" \
            --exclude "backend/legalai.db" \
            --exclude "backend/dev.db" \
            ./ "${SSH_USER}@${SSH_HOST}:/srv/legal-ai/"

      # ---------------- MAIN REMOTE DEPLOY ----------------
      - name: Run remote deploy script
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "SENTRY_DSN='${SENTRY_DSN}' bash -s" <<'EOF'
          set -e

          PROJECT_ROOT="/srv/legal-ai"
          BACKEND="$PROJECT_ROOT/backend"
          DATA="$PROJECT_ROOT/data"
          LOGS="$PROJECT_ROOT/deploy_logs"

          mkdir -p "$DATA"
          mkdir -p "$LOGS"

          TIMESTAMP="$(date +%Y%m%d-%H%M%S)"
          LOG_FILE="$LOGS/deploy_${TIMESTAMP}.log"

          exec > >(tee -a "$LOG_FILE") 2>&1

          echo "=== START DEPLOY $TIMESTAMP ==="

          # ------------ DB MOVE ------------
          OLD_DB="$BACKEND/legalai.db"
          NEW_DB="$DATA/legalai.db"

          if [ -f "$OLD_DB" ] && [ ! -f "$NEW_DB" ]; then
            echo "[DB] Перенос старой БД → $NEW_DB"
            mv "$OLD_DB" "$NEW_DB"
          fi

          if [ ! -f "$NEW_DB" ]; then
            echo "[DB] БД не найдена, создаю пустую..."
            touch "$NEW_DB"
          fi

          chmod 666 "$NEW_DB" || true

          # ------------ VENV ------------
          cd "$BACKEND"
          if [ ! -d ".venv" ]; then
            echo "[VENV] Создаю .venv..."
            python3 -m venv .venv
          fi

          . .venv/bin/activate

          # ------------ REQUIREMENTS OPTIMIZE ------------
          REQ_HASH_NEW="$(sha256sum requirements.txt | awk '{print $1}')"
          REQ_HASH_FILE=".venv/requirements.sha256"
          REQ_HASH_OLD=""

          [ -f "$REQ_HASH_FILE" ] && REQ_HASH_OLD="$(cat "$REQ_HASH_FILE")"

          if [ "$REQ_HASH_NEW" != "$REQ_HASH_OLD" ]; then
            echo "[PIP] Устанавливаю зависимости..."
            pip install --upgrade pip
            pip install -r requirements.txt
            echo "$REQ_HASH_NEW" > "$REQ_HASH_FILE"
          else
            echo "[PIP] Зависимости без изменений."
          fi

          # ------------ UPDATE .env ------------
          ENV="$BACKEND/.env"

          echo "[ENV] Обновляю .env..."
          [ -f "$ENV" ] && cp "$ENV" "$ENV.$TIMESTAMP.bak"

          sed -i '/^DATABASE_URL=/d' "$ENV"
          sed -i '/^SENTRY_DSN=/d' "$ENV"

          echo "DATABASE_URL=sqlite:////srv/legal-ai/data/legalai.db" >> "$ENV"
          echo "SENTRY_DSN=${SENTRY_DSN}" >> "$ENV"

          # ------------ INIT LAWS TABLE ------------
          python <<'PY'
from app.db import Base, engine
from app.laws.models import Law
print("[INIT_LAWS] Creating laws table if not exists...")
Base.metadata.create_all(bind=engine, tables=[Law.__table__])
print("[INIT_LAWS] Done.")
PY

          # ------------ RESTART SERVICE ------------
          echo "[SERVICE] Перезапускаю legalai.service..."
          sudo systemctl daemon-reload || true
          sudo systemctl restart legalai.service

          sleep 5
          echo "[CHECK] Проверяю /health..."

          HTTP_CODE="$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:8000/health || echo 000)"
          echo "[CHECK] Код /health → $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "[ERROR] /health != 200 — требуется откат!"
            exit 2
          fi

          echo "=== DEPLOY FINISHED SUCCESSFULLY ==="
EOF
