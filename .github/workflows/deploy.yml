name: Deploy LegalAI

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-legalai
  cancel-in-progress: false

jobs:
  # 1) Тестируем backend перед деплоем
  test-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install backend dependencies
        run: |
          pip install -r backend/requirements.txt

      - name: Set PYTHONPATH for backend
        run: |
          echo "PYTHONPATH=$PWD/backend:$PYTHONPATH" >> $GITHUB_ENV

      - name: Run backend tests
        run: |
          pytest -q

  # 2) Деплой на сервер (только если тесты прошли)
  deploy:
    needs: test-backend
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Опционально: билд фронтенда, только если есть frontend/package.json
      - name: Detect frontend
        id: detect-fe
        run: |
          if [ -f "frontend/package.json" ]; then
            echo "has_fe=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_fe=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Node (if frontend exists)
        if: steps.detect-fe.outputs.has_fe == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Build frontend (if present)
        if: steps.detect-fe.outputs.has_fe == 'true'
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Add server to known_hosts
        run: |
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      # Синхронизация кода на сервере (repo -> /srv/legal-ai)
      - name: Rsync project to server
        run: |
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude "frontend/node_modules" \
            ./ "${SSH_USER}@${SSH_HOST}:/srv/legal-ai/"

      # Основной деплой-скрипт на сервере
      - name: Run remote deploy script
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "SENTRY_DSN='${SENTRY_DSN}' bash -s" << 'EOF'
          set -e

          echo "[DEPLOY] Начало деплоя на сервере..."

          cd /srv/legal-ai/backend

          # Подготовка виртуального окружения
          if [ ! -d ".venv" ]; then
            echo "[DEPLOY] Создаём виртуальное окружение..."
            python3 -m venv .venv
          fi

          echo "[DEPLOY] Активируем .venv и обновляем зависимости..."
          . .venv/bin/activate
          pip install -r requirements.txt

          # Безопасное обновление .env (с бэкапом и установкой SENTRY_DSN)
          if [ -f ".env" ]; then
            echo "[DEPLOY] Бэкап .env..."
            cp .env ".env.$(date +%Y%m%d-%H%M%S).bak"
          else
            echo "[DEPLOY] Создаём новый .env..."
            touch .env
          fi

          # Удаляем старую строку SENTRY_DSN, если была
          sed -i '/^SENTRY_DSN=/d' .env

          # Добавляем актуальное значение (может быть пустым, это не ошибка)
          echo "SENTRY_DSN=${SENTRY_DSN}" >> .env

          echo "[DEPLOY] Текущее значение SENTRY_DSN в .env:"
          grep '^SENTRY_DSN=' .env || echo "SENTRY_DSN не установлен"

          # Перезапуск сервиса
          echo "[DEPLOY] Перезапускаем legalai.service..."
          sudo systemctl daemon-reload || true
          sudo systemctl restart legalai.service

          echo "[DEPLOY] Ждём 5 секунд перед проверкой статуса..."
          sleep 5

          sudo systemctl status legalai.service -n 20 || true

          echo "[DEPLOY] Проверяем /health..."
          curl -s -o /dev/null -w "%{http_code}\n" http://127.0.0.1:8000/health

          echo "[DEPLOY] Скрипт деплоя завершён."
          EOF

