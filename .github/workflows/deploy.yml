name: Deploy LegalAI

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-legalai
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Проверяем, есть ли фронтенд
      - name: Detect frontend
        id: detect-fe
        run: |
          if [ -f "frontend/package.json" ]; then
            echo "has_fe=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_fe=false" >> "$GITHUB_OUTPUT"
          fi

      # 2. Если фронтенд есть — ставим Node и собираем
      - name: Setup Node
        if: steps.detect-fe.outputs.has_fe == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build frontend
        if: steps.detect-fe.outputs.has_fe == 'true'
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      # 3. Готовим SSH (ключ + known_hosts)
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # 4. Деплой кода на сервер через rsync
      - name: Rsync project to server
        run: |
          rsync -az --delete \
            --exclude=".git" \
            --exclude=".github" \
            -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes" \
            ./ "${SSH_USER}@${SSH_HOST}:/srv/legal-ai/"

      # 5. Обновление .env, рестарт сервиса и health-check
      - name: Remote deploy script
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes \
            "${SSH_USER}@${SSH_HOST}" \
            "SENTRY_DSN='${SENTRY_DSN}' bash -s" << 'EOF'
          set -euo pipefail

          cd /srv/legal-ai

          # Гарантируем .env
          if [ ! -f ".env" ]; then
            touch .env
          fi

          # Обновляем или добавляем SENTRY_DSN в .env
          if grep -q '^SENTRY_DSN=' .env; then
            sed -i "s|^SENTRY_DSN=.*$|SENTRY_DSN=${SENTRY_DSN}|" .env
          else
            echo "SENTRY_DSN=${SENTRY_DSN}" >> .env
          fi

          # При необходимости можно обновить зависимости backend/frontend:
          # cd backend && .venv/bin/pip install -r requirements.txt || true
          # cd /srv/legal-ai/frontend && npm ci && npm run build || true
          cd /srv/legal-ai

          # Рестарт backend
          systemctl restart legalai.service

          echo "Waiting for backend to come up..."
          sleep 5

          # Health-check API
          if ! curl -k -f https://api.legalai.su/health >/dev/null 2>&1; then
            echo "ERROR: /health failed, showing last logs:"
            journalctl -u legalai.service -n 50 || true
            exit 1
          fi

          echo "/health OK"

          # Мягкая проверка debug-sentry (если включено)
          if curl -k -f https://api.legalai.su/debug-sentry >/dev/null 2>&1; then
            echo "/debug-sentry OK"
          else
            echo "debug-sentry not available (non-fatal)"
          fi

          echo "Deploy completed successfully."
          EOF
