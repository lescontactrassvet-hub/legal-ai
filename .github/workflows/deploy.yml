      - name: Run deploy commands via SSH (native, stable)
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${SSH_USER}@${SSH_HOST} \
            "SENTRY_DSN='${SENTRY_DSN}' bash -s" << 'EOF'

            set -euo pipefail

            echo 'ðŸ“Œ Sync backend'
            rsync -az --delete /srv/legal-ai/repo/backend/ /srv/legal-ai/backend/

            echo 'ðŸ“Œ Sync frontend'
            rsync -az --delete /srv/legal-ai/repo/frontend/ /srv/legal-ai/frontend/

            echo 'ðŸ“Œ Ensure SENTRY_DSN'
            cd /srv/legal-ai/backend
            touch .env
            if grep -q '^SENTRY_DSN=' .env; then
              sed -i "s#^SENTRY_DSN=.*#SENTRY_DSN=${SENTRY_DSN}#g" .env
            else
              echo "SENTRY_DSN=${SENTRY_DSN}" >> .env
            fi

            echo 'ðŸ“Œ Backend venv install'
            if [ ! -d ".venv" ]; then python3 -m venv .venv; fi
            source .venv/bin/activate
            pip install -r requirements.txt

            echo 'ðŸ“Œ Restart FastAPI'
            systemctl daemon-reload
            systemctl restart legalai.service
            sleep 2
            systemctl status legalai.service -n 20 || true

            echo 'ðŸ“Œ Health checks'
            curl -sk https://api.legalai.su/health || true
            curl -sk -o /dev/null -w "%{http_code}\n" https://api.legalai.su/debug-sentry || true

EOF
