name: Deploy backend

on:
  # Ручной запуск из вкладки Actions
  workflow_dispatch:

  # Вызов как reusable-workflow из .github/workflows/deploy.yml (uses: …)
  workflow_call:

  # Авто-запуск при изменениях в backend или самом workflow
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"

concurrency:
  group: deploy-backend
  cancel-in-progress: false

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python (for future tooling if needed)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Подготавливаем SSH-ключ для доступа к серверу
      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Add server to known_hosts
        run: |
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      # Бэкап проекта на сервере ДО rsync (на всякий случай)
      - name: Backup project on server (pre-rsync)
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" 'bash -s' << 'EOF'
          set -e
          PROJECT_ROOT="/srv/legal-ai"
          BACKUP_ROOT="${PROJECT_ROOT}/backups"
          TIMESTAMP="$(date +%Y%m%d-%H%M%S)"

          mkdir -p "$BACKUP_ROOT"

          if [ -d "$PROJECT_ROOT" ]; then
            echo "[BACKUP] Создаём бэкап проекта в ${BACKUP_ROOT}/legal-ai_${TIMESTAMP}.tar.gz"
            tar -czf "${BACKUP_ROOT}/legal-ai_${TIMESTAMP}.tar.gz" \
              --ignore-failed-read \
              --warning=no-file-changed \
              --exclude='./backups' \
              --exclude='./deploy_logs' \
              --exclude='./data' \
              -C /srv legal-ai || true
          else
            echo "[BACKUP] Каталог ${PROJECT_ROOT} не найден, бэкап не требуется."
          fi
          EOF

      # Синхронизация кода (но НЕ данных и БД) на сервер
      - name: Rsync project to server
        run: |
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude "frontend/node_modules" \
            --exclude "data/" \
            --exclude "backend/legalai.db" \
            --exclude "backend/dev.db" \
            ./ "${SSH_USER}@${SSH_HOST}:/srv/legal-ai/"

      # Основной деплой-скрипт на сервере
      - name: Run remote deploy script
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "SENTRY_DSN='${SENTRY_DSN}' bash -s" << 'EOF'
          set -e

          PROJECT_ROOT="/srv/legal-ai"
          BACKUP_ROOT="${PROJECT_ROOT}/backups"
          LOG_ROOT="${PROJECT_ROOT}/deploy_logs"
          DATA_ROOT="${PROJECT_ROOT}/data"
          OLD_DB="${PROJECT_ROOT}/backend/legalai.db"
          NEW_DB="${DATA_ROOT}/legalai.db"
          TIMESTAMP="$(date +%Y%m%d-%H%M%S)"
          LOG_FILE="${LOG_ROOT}/deploy_${TIMESTAMP}.log"

          mkdir -p "$LOG_ROOT"
          mkdir -p "$DATA_ROOT"

          # Логируем все действия деплоя в файл + на экран
          exec > >(tee -a "$LOG_FILE") 2>&1

          echo "[DEPLOY] Запуск деплоя: ${TIMESTAMP}"
          echo "[DEPLOY] PROJECT_ROOT=${PROJECT_ROOT}"
          echo "[DEPLOY] DATA_ROOT=${DATA_ROOT}"

          # --- Одноразовый перенос старой БД в /data ---
          if [ -f "$OLD_DB" ] && [ ! -f "$NEW_DB" ]; then
            echo "[DB] Обнаружена старая база ${OLD_DB}, переносим в ${NEW_DB}"
            mv "$OLD_DB" "$NEW_DB"
          else
            echo "[DB] Перенос базы не требуется (старой БД нет или новая уже существует)."
          fi

          # --- Гарантируем наличие файла БД ---
          if [ ! -f "$NEW_DB" ]; then
            echo "[DB] Файл БД отсутствует → создаём новый пустой SQLite"
            if command -v sqlite3 >/dev/null 2>&1; then
              sqlite3 "$NEW_DB" "VACUUM;" || true
            else
              echo "[DB] ВНИМАНИЕ: sqlite3 не установлен, создаём пустой файл БД"
              touch "$NEW_DB"
            fi
          fi

          chmod 666 "$NEW_DB" || true
          echo "[DB] Итоговый файл БД: $NEW_DB"

          cd "${PROJECT_ROOT}/backend"

          # Подготовка виртуального окружения
          if [ ! -d ".venv" ]; then
            echo "[DEPLOY] .venv не найдено, создаём..."
            python3 -m venv .venv
          fi

          echo "[DEPLOY] Активируем .venv..."
          . .venv/bin/activate

          # Проверяем изменения в requirements.txt (оптимизация pip install)
          echo "[DEPLOY] Проверяем hash requirements.txt..."
          REQ_HASH_NEW="$(sha256sum requirements.txt | awk '{print $1}')"
          REQ_HASH_FILE=".venv/requirements.sha256"
          REQ_HASH_OLD=""
          if [ -f "$REQ_HASH_FILE" ]; then
            REQ_HASH_OLD="$(cat "$REQ_HASH_FILE" || true)"
          fi

          if [ "$REQ_HASH_NEW" != "$REQ_HASH_OLD" ]; then
            echo "[DEPLOY] Зависимости изменились, устанавливаем..."
            pip install --upgrade pip
            pip install -r requirements.txt
            echo "$REQ_HASH_NEW" > "$REQ_HASH_FILE"
          else
            echo "[DEPLOY] Зависимости НЕ изменились, пропускаем pip install."
          fi

          # Безопасное обновление .env (с бэкапом и установкой DATABASE_URL/SENTRY_DSN)
          ENV_FILE=".env"
          if [ -f "$ENV_FILE" ]; then
            ENV_BAK="${ENV_FILE}.$(date +%Y%m%d-%H%M%S).bak"
            echo "[DEPLOY] Бэкап .env -> ${ENV_BAK}"
            cp "$ENV_FILE" "$ENV_BAK"
          else
            echo "[DEPLOY] .env не найден, создаём новый..."
            touch "$ENV_FILE"
          fi

          # DATABASE_URL → всегда на /srv/legal-ai/data/legalai.db
          sed -i '/^DATABASE_URL=/d' "$ENV_FILE"
          echo "DATABASE_URL=sqlite:////srv/legal-ai/data/legalai.db" >> "$ENV_FILE"

          # Удаляем старую строку SENTRY_DSN, если была
          sed -i '/^SENTRY_DSN=/d' "$ENV_FILE"
          # Добавляем актуальное значение (может быть пустым — не ошибка)
          echo "SENTRY_DSN=${SENTRY_DSN}" >> "$ENV_FILE"

          echo "[DEPLOY] Текущее значение DATABASE_URL и SENTRY_DSN в .env:"
          grep '^DATABASE_URL=' "$ENV_FILE" || echo "[DEPLOY] DATABASE_URL не установлен"
          grep '^SENTRY_DSN=' "$ENV_FILE" || echo "[DEPLOY] SENTRY_DSN не установлен"

          # === Инициализируем таблицу laws (если отсутствует) ===
          echo "[DEPLOY] Инициализируем таблицу laws (если отсутствует)..."
          python << 'PYEOF'
          from app.db import Base, engine
          from app.laws.models import Law

          print("[INIT_LAWS] Creating laws table if not exists...")
          Base.metadata.create_all(bind=engine, tables=[Law.__table__])
          print("[INIT_LAWS] Done.")
          PYEOF

          # === Установка/обновление CRON для синхронизации законов ===
          if [ -f "${PROJECT_ROOT}/deploy/infra/setup_laws_cron.sh" ]; then
            echo "[DEPLOY] Обновляем cron-задачу для синхронизации законов..."
            bash "${PROJECT_ROOT}/deploy/infra/setup_laws_cron.sh" || echo "[DEPLOY] setup_laws_cron.sh завершился с ошибкой"
          else
            echo "[DEPLOY] ВНИМАНИЕ: setup_laws_cron.sh не найден, cron для законов не обновлён."
          fi

          # Перезапуск сервиса
          echo "[DEPLOY] Перезапускаем legalai.service..."
          sudo systemctl daemon-reload || true
          sudo systemctl restart legalai.service

          echo "[DEPLOY] Ждём 5 секунд перед проверкой статуса..."
          sleep 5

          echo "[DEPLOY] Статус legalai.service:"
          sudo systemctl status legalai.service -n 20 || true

          # Проверяем /health
          echo "[DEPLOY] Проверяем /health..."
          set +e
          HTTP_CODE="$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:8000/health || echo '000')"
          set -e
          echo "[DEPLOY] Код ответа /health: ${HTTP_CODE}"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "[ERROR] /health вернул ${HTTP_CODE}, начинаем ROLLBACK..."

            LAST_BACKUP="$(ls -1t "${BACKUP_ROOT}"/legal-ai_*.tar.gz 2>/dev/null | head -n 1 || true)"
            if [ -z "$LAST_BACKUP" ]; then
              echo "[ERROR] Бэкапы не найдены, откат невозможен!"
              exit 1
            fi

            echo "[ROLLBACK] Используем бэкап: ${LAST_BACKUP}"
            echo "[ROLLBACK] Останавливаем legalai.service..."
            sudo systemctl stop legalai.service || true

            echo "[ROLLBACK] Очищаем текущий проект (кроме backups, deploy_logs и data)..."
            find "${PROJECT_ROOT}" -mindepth 1 -maxdepth 1 \
              ! -name 'backups' \
              ! -name 'deploy_logs' \
              ! -name 'data' \
              -exec rm -rf {} \;

            echo "[ROLLBACK] Восстанавливаем файлы из бэкапа..."
            tar -xzf "${LAST_BACKUP}" -C /srv

            echo "[ROLLBACK] Запускаем legalai.service после отката..."
            sudo systemctl daemon-reload || true
            sudo systemctl restart legalai.service
            sleep 5

            set +e
            HTTP_CODE_AFTER="$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:8000/health || echo '000')"
            set -e
            echo "[ROLLBACK] Код ответа /health после отката: ${HTTP_CODE_AFTER}"

            if [ "$HTTP_CODE_AFTER" != "200" ]; then
              echo "[FATAL] Откат выполнен, но сервис всё равно не вернул 200. Требуется ручная проверка."
              exit 1
            fi

            echo "[ROLLBACK] Откат успешно завершён."
          else
            echo "[DEPLOY] /health вернул 200 — деплой успешен."
          fi

          echo "[DEPLOY] Скрипт деплоя завершён."
          EOF
