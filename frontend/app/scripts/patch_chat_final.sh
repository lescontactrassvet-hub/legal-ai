#!/data/data/com.termux/files/usr/bin/bash
set -e

cd ~/legal-ai/frontend/app

CSS="src/App.css"

# === 1. –ò—â–µ–º —Ñ–∞–π–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–∞–±–æ—á–µ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ (Workspace*.tsx) ===
TSX=$(find src/pages -maxdepth 3 -type f -name "Workspace*.tsx" | head -n 1 || true)

if [ -z "$TSX" ]; then
  echo "‚ö†Ô∏è  –§–∞–π–ª Workspace*.tsx –Ω–µ –Ω–∞–π–¥–µ–Ω. –®–∞–≥ —Å –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–º –ø–æ–ª–µ–º —á–∞—Ç–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é."
else
  echo "–ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã: $TSX"

  # –ë—ç–∫–∞–ø TSX
  TSX_BACKUP="${TSX}.bak-$(date +%Y%m%d-%H%M%S)"
  cp "$TSX" "$TSX_BACKUP"
  echo "–°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø TSX: $TSX_BACKUP"

  # –ú–µ–Ω—è–µ–º input (workspace-chat-input) –Ω–∞ textarea —Å rows={2}
  # –ò—â–µ–º —Å–∞–º–æ–∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π—Å—è input —Å —ç—Ç–∏–º –∫–ª–∞—Å—Å–æ–º.
  sed -i '
    s/<input\([^>]*className=\"workspace-chat-input\"[^>]*\)\/>/<textarea\1 rows={2}><\/textarea>/g
  ' "$TSX"

  echo "‚úî –ü–æ–ø—Ä–æ–±–æ–≤–∞–ª –∑–∞–º–µ–Ω–∏—Ç—å <input ...workspace-chat-input... /> –Ω–∞ <textarea ... rows={2}></textarea>."
  echo "  –ï—Å–ª–∏ —Ç–∞–∫–æ–≥–æ input –Ω–µ –±—ã–ª–æ ‚Äî —Ñ–∞–π–ª –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Å–º. diff –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏)."
fi

# === 2. –†–∞–±–æ—Ç–∞ —Å CSS: –±—ç–∫–∞–ø + —á–∏—Å—Ç–∫–∞ –¥—É–±–ª–µ–π DocEditor ===

if [ ! -f "$CSS" ]; then
  echo "‚ùå –§–∞–π–ª $CSS –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã."
  exit 1
fi

CSS_BACKUP="${CSS}.bak-$(date +%Y%m%d-%H%M%S)"
cp "$CSS" "$CSS_BACKUP"
echo "–°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø CSS: $CSS_BACKUP"

# –£–¥–∞–ª—è–µ–º –Ω–∞—à –Ω–∏–∂–Ω–∏–π –∞–≤—Ç–æ-–±–ª–æ–∫ "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞ DocEditor",
# –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏ –∏–¥—ë—Ç –¥–æ –∫–æ–Ω—Ü–∞ —Ñ–∞–π–ª–∞.
if grep -q "=== –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞ DocEditor" "$CSS"; then
  sed -i '/\/\* === –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞ DocEditor/,${d;}' "$CSS"
  echo "‚úî –£–¥–∞–ª—ë–Ω –Ω–∏–∂–Ω–∏–π –±–ª–æ–∫ \"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞ DocEditor\" (—É–±—Ä–∞–Ω—ã –¥—É–±–ª–∏)."
else
  echo "‚ÑπÔ∏è –ë–ª–æ–∫ \"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞ DocEditor\" –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –≤–∏–¥–∏–º–æ, —É–∂–µ —É–¥–∞–ª—ë–Ω."
fi

# === 3. –î–æ–±–∞–≤–ª—è–µ–º –æ–≤–µ—Ä—Ä–∞–π–¥ –¥–ª—è —á–∞—Ç–∞ (—Ñ–∏–∫—Å. —Ä–∞–∑–º–µ—Ä + –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω–ø—É—Ç) ===

if grep -q "AUTO PATCH: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —á–∞—Ç–∞ –∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –≤–≤–æ–¥" "$CSS"; then
  echo "‚ÑπÔ∏è CSS-–ø–∞—Ç—á –¥–ª—è —á–∞—Ç–∞ —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–µ –¥–æ–±–∞–≤–ª—è—é."
else
  cat << 'CSS_EOF' >> "$CSS"

/* === AUTO PATCH: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —á–∞—Ç–∞ –∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –≤–≤–æ–¥ === */

/* –ö–æ—Ä–æ–±–∫–∞ —á–∞—Ç–∞ –¢–∞—Ç—å—è–Ω–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞, –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É */
.workspace-chat-box {
  height: 520px;            /* –¥–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
}

/* –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–Ω–∏–º–∞—é—Ç –≤—Å—ë —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –∏ —Å–∫—Ä–æ–ª–ª—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ */
.workspace-chat-messages {
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
}

/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ ‚Äî —Ä–µ–∞–ª—å–Ω–æ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–µ textarea —Å –≤—ã—Å–æ—Ç–æ–π –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ */
.workspace-chat-input {
  min-height: 2.8em;
  padding-top: 8px;
  padding-bottom: 8px;
  line-height: 1.3;
}

/* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö ‚Äî —á–∞—Ç –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–µ —Å—ä–µ–¥–∞–ª —ç–∫—Ä–∞–Ω */
@media (max-width: 640px) {
  .workspace-chat-box {
    height: 420px;
  }
}

CSS_EOF

  echo "‚úî –î–æ–±–∞–≤–ª–µ–Ω CSS-–ø–∞—Ç—á –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç—ã —á–∞—Ç–∞ –∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞."
fi

echo "üéâ –°–∫—Ä–∏–ø—Ç patch_chat_final.sh –∑–∞–≤–µ—Ä—à—ë–Ω."
