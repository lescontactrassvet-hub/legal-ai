<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî LegalAI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å -->
    <link rel="stylesheet" href="/css/styles.css">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #E7F1FF; /* —Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω */
            color: #102040;
        }

        .dashboard-root {
            display: flex;
            min-height: 100vh;
        }

        /* –õ–ï–í–û–ï –ú–ï–ù–Æ */
        .sidebar {
            width: 240px;
            background: #0C235A;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            padding: 20px 18px;
            box-sizing: border-box;
        }

        .sidebar__logo {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar__logo-badge {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            background: #4C8DFF;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 800;
        }

        .sidebar__nav {
            list-style: none;
            padding: 0;
            margin: 0 0 20px;
        }

        .sidebar__nav-item {
            margin-bottom: 4px;
        }

        .sidebar__nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            color: #e0e7ff;
            text-decoration: none;
            font-size: 14px;
        }

        .sidebar__nav-link span.icon {
            width: 18px;
            text-align: center;
        }

        .sidebar__nav-link--active,
        .sidebar__nav-link:hover {
            background: rgba(255, 255, 255, 0.12);
            color: #ffffff;
        }

        .sidebar__footer {
            margin-top: auto;
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar__footer a {
            color: #c5d4ff;
            text-decoration: none;
        }

        .sidebar__footer a:hover {
            text-decoration: underline;
        }

        /* –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨ */
        .dashboard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 18px 20px;
            box-sizing: border-box;
            gap: 14px;
        }

        /* –¢–û–ü-–ü–ê–ù–ï–õ–¨ */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .topbar__left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .topbar__title {
            font-size: 22px;
            font-weight: 600;
        }

        .topbar__subtitle {
            font-size: 13px;
            color: #51607C;
        }

        .topbar__right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(16, 32, 64, 0.08);
            font-size: 12px;
        }

        .user-chip__avatar {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            background: #2563EB;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
        }

        .user-chip__info {
            display: flex;
            flex-direction: column;
        }

        .user-chip__name {
            font-weight: 500;
        }

        .user-chip__meta {
            opacity: 0.75;
        }

        /* –ö–ê–†–¢–û–ß–ö–ò / –°–ï–¢–ö–ê */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1.4fr;
            gap: 14px;
            align-items: flex-start;
        }

        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 14px 16px 14px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
            box-sizing: border-box;
        }

        .card__header {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .card__title {
            font-size: 16px;
            font-weight: 600;
        }

        .card__subtitle {
            font-size: 12px;
            color: #64748B;
        }

        .card__section-title {
            font-size: 13px;
            font-weight: 500;
            margin: 8px 0 4px;
        }

        .badge {
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 999px;
            background: #EFF4FF;
            color: #1D4ED8;
        }

        /* –ß–ê–¢ */
        .chat {
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: 380px;
        }

        .chat__messages {
            flex: 1;
            background: #F4F7FF;
            border-radius: 12px;
            padding: 8px 10px;
            overflow-y: auto;
            font-size: 13px;
        }

        .chat__placeholder {
            font-size: 12px;
            color: #9CA3AF;
        }

        .chat__message {
            max-width: 92%;
            padding: 8px 11px;
            border-radius: 12px;
            margin-bottom: 6px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat__message--ai {
            margin-right: auto;
            background: #ffffff;
            color: #111827;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(148, 163, 184, 0.4);
        }

        .chat__message--user {
            margin-left: auto;
            background: #2563EB;
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }

        .chat__meta {
            font-size: 11px;
            opacity: 0.75;
            margin-top: 4px;
        }

        .chat__composer {
            display: flex;
            gap: 6px;
        }

        .chat__textarea {
            flex: 1;
            resize: none;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            padding: 8px 12px;
            font-size: 13px;
            outline: none;
        }

        .chat__buttons {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 7px 14px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: #2563EB;
            color: #ffffff;
        }

        .btn--secondary {
            background: #EFF6FF;
            color: #1D4ED8;
        }

        .btn--ghost {
            background: transparent;
            color: #102040;
            border: 1px solid rgba(148, 163, 184, 0.6);
        }

        /* FOLLOW-UP –ö–ù–û–ü–ö–ò –ü–û–î –û–¢–í–ï–¢–û–ú –¢–ê–¢–¨–Ø–ù–´ */
        .chat__followups {
            margin-top: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .chat__followups button {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: #F9FAFB;
            font-size: 11px;
            padding: 3px 8px;
            cursor: pointer;
        }

        .chat__followups button:hover {
            background: #EFF6FF;
        }

        /* –ò–ù–î–ò–ö–ê–¢–û–† "–¢–ê–¢–¨–Ø–ù–ê –ü–ï–ß–ê–¢–ê–ï–¢" */
        .chat__typing {
            font-size: 12px;
            color: #6B7280;
            font-style: italic;
            margin-bottom: 6px;
        }

        /* –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê */
        .stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .list {
            list-style: none;
            padding: 0;
            margin: 6px 0 0;
            font-size: 13px;
            max-height: 150px;
            overflow-y: auto;
        }

        .list__item {
            padding: 6px 0;
            border-bottom: 1px dashed rgba(148, 163, 184, 0.5);
        }

        .list__item:last-child {
            border-bottom: none;
        }

        .list__title {
            font-weight: 500;
        }

        .list__meta {
            font-size: 11px;
            color: #6B7280;
        }

        .list__empty {
            font-size: 12px;
            color: #9CA3AF;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .quick-actions__btn {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: #F9FAFB;
            font-size: 12px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .quick-actions__btn:hover {
            background: #EFF6FF;
        }

        /* –ü–ê–ù–ï–õ–¨ –ê–ù–ê–õ–ò–ó–ê –§–ê–ô–õ–û–í */
        .file-panel {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            background: #F9FAFB;
            border: 1px dashed rgba(148, 163, 184, 0.8);
            font-size: 12px;
        }

        .file-panel__files {
            margin: 4px 0 6px;
        }

        .file-panel__file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 4px;
        }

        .file-panel__file-name {
            font-weight: 500;
        }

        .file-panel__links a {
            font-size: 11px;
            margin-left: 6px;
            text-decoration: none;
            color: #2563EB;
        }

        .file-panel__links a:hover {
            text-decoration: underline;
        }

        .file-panel__goal {
            margin-top: 6px;
        }

        .file-panel__goal textarea {
            width: 100%;
            min-height: 40px;
            font-size: 12px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            padding: 6px 8px;
            resize: vertical;
        }

        .file-panel__actions {
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px;
        }

        .file-panel__hint {
            font-size: 11px;
            color: #6B7280;
        }

        .file-panel__error {
            margin-top: 4px;
            font-size: 11px;
            color: #B91C1C;
        }

        /* –§–ò–õ–¨–¢–†–´ "–ó–ê–ö–û–ù–´" */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .filters select {
            font-size: 12px;
            padding: 4px 6px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            background: #F9FAFB;
        }

        /* –ê–î–ê–ü–¢–ò–í */
        @media (max-width: 1024px) {
            .dashboard-root {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                flex-direction: row;
                align-items: center;
                gap: 12px;
                overflow-x: auto;
            }
            .sidebar__footer {
                display: none;
            }
            .dashboard-main {
                padding: 12px;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .chat {
                height: 320px;
            }
        }
    </style>
</head>
<body>
<div class="dashboard-root">
    <!-- –õ–ï–í–û–ï –ú–ï–ù–Æ -->
    <aside class="sidebar">
        <div class="sidebar__logo">
            <div class="sidebar__logo-badge">L</div>
            LegalAI
        </div>

        <ul class="sidebar__nav">
            <li class="sidebar__nav-item">
                <a class="sidebar__nav-link sidebar__nav-link--active" href="/dashboard">
                    <span class="icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span>
                </a>
            </li>
            <li class="sidebar__nav-item">
                <a class="sidebar__nav-link" href="#consult">
                    <span class="icon">üí¨</span><span>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</span>
                </a>
            </li>
            <li class="sidebar__nav-item">
                <a class="sidebar__nav-link" href="#docs">
                    <span class="icon">üìÑ</span><span>–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
                </a>
            </li>
            <li class="sidebar__nav-item">
                <a class="sidebar__nav-link" href="#laws">
                    <span class="icon">‚öñÔ∏è</span><span>–ó–∞–∫–æ–Ω—ã</span>
                </a>
            </li>
            <li class="sidebar__nav-item">
                <a class="sidebar__nav-link" href="#files">
                    <span class="icon">üìÅ</span><span>–§–∞–π–ª—ã</span>
                </a>
            </li>
            <li class="sidebar__nav-item">
                <a class="sidebar__nav-link" href="#profile">
                    <span class="icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                </a>
            </li>
        </ul>

        <div class="sidebar__footer">
            <div>¬© <span id="footer-year"></span> LegalAI</div>
            <div><a href="/legal">–ü—Ä–∞–≤–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</a></div>
        </div>
    </aside>

    <!-- –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨ -->
    <main class="dashboard-main">
        <!-- –¢–û–ü-–ü–ê–ù–ï–õ–¨ -->
        <header class="topbar">
            <div class="topbar__left">
                <div class="topbar__title">–ü–∞–Ω–µ–ª—å LegalAI</div>
                <div class="topbar__subtitle" id="topbar-date">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç—ã...
                </div>
                <div class="topbar__subtitle">
                    –í–∞—à –ò–ò-—é—Ä–∏—Å—Ç: <strong>–Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞</strong> (–Æ—Ä–∏—Å—Ç –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞)
                </div>
            </div>

            <div class="topbar__right">
                <div class="user-chip" id="profile-mini">
                    <div class="user-chip__avatar" id="user-avatar">U</div>
                    <div class="user-chip__info">
                        <div class="user-chip__name" id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                        <div class="user-chip__meta" id="user-meta">
                            –Ø–∑—ã–∫: RU ¬∑ –°—Ç—Ä–∞–Ω–∞: –†–§
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- –û–°–ù–û–í–ù–ê–Ø –°–ï–¢–ö–ê -->
        <section class="dashboard-grid">
            <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
            <section>
                <!-- AI-–ö–û–ù–°–£–õ–¨–¢–ê–ù–¢ + –§–ê–ô–õ–´ -->
                <section class="card" id="consult">
                    <div class="card__header">
                        <div>
                            <div class="card__title">–Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞ ‚Äî –ò–ò-—é—Ä–∏—Å—Ç</div>
                            <div class="card__subtitle">
                                –û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç. –¢–∞—Ç—å—è–Ω–∞ —É—Ç–æ—á–Ω–∏—Ç –¥–µ—Ç–∞–ª–∏, –Ω–∞–π–¥—ë—Ç –Ω–æ—Ä–º—ã –∑–∞–∫–æ–Ω–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π.
                            </div>
                        </div>
                        <span class="badge">AI ¬∑ RAG ¬∑ –ë–∞–∑–∞ –∑–∞–∫–æ–Ω–æ–≤</span>
                    </div>

                    <div class="chat">
                        <div class="chat__messages" id="chat-messages">
                            <div class="chat__placeholder">
                                –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞...
                            </div>
                        </div>

                        <div class="chat__composer">
                            <textarea
                                id="chat-input"
                                class="chat__textarea"
                                rows="1"
                                placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..."
                            ></textarea>
                            <div class="chat__buttons">
                                <button class="btn" type="button" id="chat-send">
                                    ‚û§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                </button>
                                <button class="btn btn--secondary" type="button" id="chat-voice">
                                    üéô –ì–æ–ª–æ—Å
                                </button>
                                <button class="btn btn--ghost" type="button" id="chat-attach">
                                    üìé –§–∞–π–ª
                                </button>
                            </div>
                        </div>

                        <!-- –ü–ê–ù–ï–õ–¨ –í–´–ë–û–†–ê –§–ê–ô–õ–û–í –ò –¶–ï–õ–ò –ê–ù–ê–õ–ò–ó–ê -->
                        <div class="file-panel" id="file-panel" hidden>
                            <div><strong>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–¥–æ 4, –º–∞–∫—Å–∏–º—É–º –ø–æ 30 –ú–ë):</strong></div>
                            <div class="file-panel__files" id="file-panel-files"></div>
                            <div class="file-panel__goal">
                                <label for="file-goal">
                                    –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç –∞–Ω–∞–ª–∏–∑–∞ —ç—Ç–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤? <span style="color:#B91C1C">*</span>
                                </label>
                                <textarea id="file-goal" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ —Ä–∏—Å–∫–∏, —É–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å, –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å..."></textarea>
                            </div>
                            <div class="file-panel__actions">
                                <div class="file-panel__hint">
                                    –û—Ç–≤–µ—Ç –Æ–ò–ò –¢–∞—Ç—å—è–Ω—ã: –ø—Ä–æ–±–ª–µ–º—ã ‚Üí –ø—Ä–∏—á–∏–Ω—ã ‚Üí —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å, —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã.
                                </div>
                                <button class="btn btn--secondary" type="button" id="file-analyze-btn" disabled>
                                    üîç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏–∑
                                </button>
                            </div>
                            <div class="file-panel__error" id="file-panel-error"></div>
                        </div>
                    </div>
                </section>

                <!-- –ò–°–¢–û–†–ò–Ø –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ô (–∫–∞—Ä–∫–∞—Å) -->
                <section class="card" id="history">
                    <div class="card__header">
                        <div>
                            <div class="card__title">–ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π</div>
                            <div class="card__subtitle">
                                –ü–æ–∑–∂–µ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–µ–π—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–µ–ª–∞ –Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫ –Ω–∏–º –≤–µ—Ä–Ω—É—Ç—å—Å—è.
                            </div>
                        </div>
                    </div>
                    <ul class="list" id="history-list">
                        <li class="list__empty">–ò—Å—Ç–æ—Ä–∏—è –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.</li>
                    </ul>
                </section>
            </section>

            <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
            <section class="stack">
                <!-- –ë–´–°–¢–†–´–ï –Æ–†–ò–î–ò–ß–ï–°–ö–ò–ï –î–ï–ô–°–¢–í–ò–Ø -->
                <section class="card" id="quick-actions-card">
                    <div class="card__header">
                        <div>
                            <div class="card__title">–ë—ã—Å—Ç—Ä—ã–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
                            <div class="card__subtitle">
                                –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É ‚Äî –Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –Ω—É–∂–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.
                            </div>
                        </div>
                    </div>

                    <div class="quick-actions">
                        <button class="quick-actions__btn" type="button" data-action="contract">üìë –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä</button>
                        <button class="quick-actions__btn" type="button" data-action="complaint">‚úâÔ∏è –°–æ—Å—Ç–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
                        <button class="quick-actions__btn" type="button" data-action="claim">‚öñÔ∏è –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏—Å–∫</button>
                        <button class="quick-actions__btn" type="button" data-action="check-doc">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
                        <button class="quick-actions__btn" type="button" data-action="analyze-files">üìÑ PDF/Word –Ω–∞ –∞–Ω–∞–ª–∏–∑</button>
                    </div>
                </section>

                <!-- –ú–û–ò –î–û–ö–£–ú–ï–ù–¢–´ -->
                <section class="card" id="docs">
                    <div class="card__header">
                        <div>
                            <div class="card__title">–ú–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</div>
                            <div class="card__subtitle">
                                –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã LegalDocAI.
                            </div>
                        </div>
                    </div>
                    <ul class="list" id="docs-list">
                        <li class="list__empty">–î–æ–∫—É–º–µ–Ω—Ç—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</li>
                    </ul>
                </section>

                <!-- –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ó–ê–ö–û–ù–û–í -->
                <section class="card" id="laws">
                    <div class="card__header">
                        <div>
                            <div class="card__title" id="laws-title">
                                –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –∑–∞–∫–æ–Ω–æ–≤ –Ω–∞ [–¥–∞—Ç–∞]
                            </div>
                            <div class="card__subtitle">
                                –ê–∫—Ç—ã, –≤—Å—Ç—É–ø–∏–≤—à–∏–µ –≤ —Å–∏–ª—É. –§–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç—Ä–∞–Ω–µ, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∏ –ø–µ—Ä–∏–æ–¥—É.
                            </div>
                        </div>
                    </div>

                    <div class="filters">
                        <select id="filter-country">
                            <option value="">–°—Ç—Ä–∞–Ω–∞: –≤—Å–µ</option>
                            <option value="RU">–†–§</option>
                            <option value="BY">–ë–µ–ª–∞—Ä—É—Å—å</option>
                            <option value="UA">–£–∫—Ä–∞–∏–Ω–∞</option>
                            <option value="EU">–ï–°</option>
                        </select>
                        <select id="filter-category">
                            <option value="">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –≤—Å–µ</option>
                            <option value="civil">–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–µ</option>
                            <option value="criminal">–£–≥–æ–ª–æ–≤–Ω–æ–µ</option>
                            <option value="housing">–ñ–∏–ª–∏—â–Ω–æ–µ</option>
                            <option value="family">–°–µ–º–µ–π–Ω–æ–µ</option>
                            <option value="migration">–ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ</option>
                        </select>
                        <select id="filter-period">
                            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="7d">7 –¥–Ω–µ–π</option>
                            <option value="30d">30 –¥–Ω–µ–π</option>
                        </select>
                    </div>

                    <ul class="list" id="laws-list">
                        <li class="list__empty">–î–∞–Ω–Ω—ã–µ –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º –∑–∞–∫–æ–Ω–æ–≤ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</li>
                    </ul>
                </section>

                <!-- –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´ -->
                <section class="card" id="status">
                    <div class="card__header">
                        <div>
                            <div class="card__title">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</div>
                            <div class="card__subtitle">
                                –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ AI –∏ –±–∞–∑—ã –∑–∞–∫–æ–Ω–æ–≤ (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –Ω–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞).
                            </div>
                        </div>
                    </div>
                    <ul class="list">
                        <li class="list__item">
                            <div class="list__title">AI (–Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞)</div>
                            <div class="list__meta" id="status-ai">–°—Ç–∞—Ç—É—Å: OK</div>
                        </li>
                        <li class="list__item">
                            <div class="list__title">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –∑–∞–∫–æ–Ω–æ–≤</div>
                            <div class="list__meta" id="status-laws">–°—Ç–∞—Ç—É—Å: OK</div>
                        </li>
                    </ul>
                </section>

                <!-- –ü–†–û–§–ò–õ–¨/–ù–ê–°–¢–†–û–ô–ö–ò -->
                <section class="card" id="profile">
                    <div class="card__header">
                        <div>
                            <div class="card__title">–ü—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                            <div class="card__subtitle">
                                –í –¥–∞–ª—å–Ω–µ–π—à–µ–º –∑–¥–µ—Å—å –±—É–¥—É—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞, —Å—Ç—Ä–∞–Ω—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (2FA).
                            </div>
                        </div>
                    </div>
                    <div class="card__section">
                        <div class="card__section-title">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
                        <div class="list__meta">RU (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ)</div>

                        <div class="card__section-title" style="margin-top: 8px;">–°—Ç—Ä–∞–Ω–∞ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞</div>
                        <div class="list__meta">–†–§ / –ë–µ–ª–∞—Ä—É—Å—å / –£–∫—Ä–∞–∏–Ω–∞ / –ï–° (–≤—ã–±–æ—Ä –ø–æ–∑–∂–µ)</div>
                    </div>
                </section>
            </section>
        </section>
    </main>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è —Ñ–∞–π–ª–æ–≤ -->
<input
    type="file"
    id="file-input"
    multiple
    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.mp3,.wav,.m4a"
    style="display:none"
/>

<script>
    // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï: –î–ê–¢–ê –ò –ó–ê–ì–û–õ–û–í–ö–ò =====
    (function initDate() {
        const now = new Date();
        const months = [
            "—è–Ω–≤–∞—Ä—è", "—Ñ–µ–≤—Ä–∞–ª—è", "–º–∞—Ä—Ç–∞", "–∞–ø—Ä–µ–ª—è", "–º–∞—è", "–∏—é–Ω—è",
            "–∏—é–ª—è", "–∞–≤–≥—É—Å—Ç–∞", "—Å–µ–Ω—Ç—è–±—Ä—è", "–æ–∫—Ç—è–±—Ä—è", "–Ω–æ—è–±—Ä—è", "–¥–µ–∫–∞–±—Ä—è"
        ];
        const d = now.getDate();
        const m = months[now.getMonth()];
        const y = now.getFullYear();

        const topbarDate = document.getElementById("topbar-date");
        if (topbarDate) {
            topbarDate.textContent = "–°–µ–≥–æ–¥–Ω—è: " + d + " " + m + " " + y;
        }

        const footerYear = document.getElementById("footer-year");
        if (footerYear) {
            footerYear.textContent = String(y);
        }

        const lawsTitle = document.getElementById("laws-title");
        if (lawsTitle) {
            lawsTitle.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –∑–∞–∫–æ–Ω–æ–≤ –Ω–∞ " + d + " " + m + " " + y;
        }
    })();

    // ===== –°–û–°–¢–û–Ø–ù–ò–ï –î–õ–Ø –§–ê–ô–õ–û–í =====
    let selectedFiles = [];
    const fileObjectUrls = new Map(); // file.name -> objectURL

    const fileInputEl = document.getElementById("file-input");
    const filePanelEl = document.getElementById("file-panel");
    const filePanelFilesEl = document.getElementById("file-panel-files");
    const fileGoalEl = document.getElementById("file-goal");
    const fileAnalyzeBtn = document.getElementById("file-analyze-btn");
    const filePanelErrorEl = document.getElementById("file-panel-error");

    const chatMessagesEl = document.getElementById("chat-messages");
    const chatInputEl = document.getElementById("chat-input");
    const chatSendBtn = document.getElementById("chat-send");
    const chatAttachBtn = document.getElementById("chat-attach");

    let typingEl = null;

    function removePlaceholder() {
        if (!chatMessagesEl) return;
        const placeholder = chatMessagesEl.querySelector(".chat__placeholder");
        if (placeholder) placeholder.remove();
    }

    function showTypingIndicator() {
        if (!chatMessagesEl) return;
        if (typingEl) return;
        typingEl = document.createElement("div");
        typingEl.className = "chat__typing";
        typingEl.textContent = "–Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞ –ø–µ—á–∞—Ç–∞–µ—Ç...";
        chatMessagesEl.appendChild(typingEl);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function hideTypingIndicator() {
        if (!chatMessagesEl || !typingEl) return;
        if (typingEl.parentNode === chatMessagesEl) {
            chatMessagesEl.removeChild(typingEl);
        }
        typingEl = null;
    }

    function addUserMessage(text) {
        if (!chatMessagesEl) return;
        removePlaceholder();
        const msg = document.createElement("div");
        msg.className = "chat__message chat__message--user";
        msg.innerHTML = `
            <div>${text}</div>
            <div class="chat__meta">–í—ã</div>
        `;
        chatMessagesEl.appendChild(msg);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function addAiMessage(html, metaHtml, withFollowups = false) {
        if (!chatMessagesEl) return;
        removePlaceholder();
        const msg = document.createElement("div");
        msg.className = "chat__message chat__message--ai";

        let meta = metaHtml || '<div class="chat__meta">–Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞ ¬∑ –ò–ò-—é—Ä–∏—Å—Ç</div>';

        let followups = "";
        if (withFollowups) {
            followups = `
                <div class="chat__followups">
                    <button type="button" data-followup="document">–°–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
                    <button type="button" data-followup="simplify">–û–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–æ—â–µ</button>
                    <button type="button" data-followup="risks">–û—Ü–µ–Ω–∏—Ç—å —Ä–∏—Å–∫–∏</button>
                </div>
            `;
        }

        msg.innerHTML = `
            <div>${html}</div>
            ${meta}
            ${followups}
        `;
        chatMessagesEl.appendChild(msg);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;

        if (withFollowups) {
            const followupButtons = msg.querySelectorAll(".chat__followups button");
            followupButtons.forEach(btn => {
                btn.addEventListener("click", () => {
                    const f = btn.getAttribute("data-followup");
                    if (!chatInputEl) return;
                    if (f === "document") {
                        chatInputEl.value = "–°–æ—Å—Ç–∞–≤—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–µ–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ –æ–ø–∏—Å–∞–Ω–Ω–æ–π –≤—ã—à–µ —Å–∏—Ç—É–∞—Ü–∏–∏.";
                    } else if (f === "simplify") {
                        chatInputEl.value = "–û–±—ä—è—Å–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ—â–µ –∏ –∫–æ—Ä–æ—á–µ, —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ –Ω–µ—é—Ä–∏—Å—Ç—É.";
                    } else if (f === "risks") {
                        chatInputEl.value = "–û—Ü–µ–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ –≤ –º–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.";
                    }
                    chatInputEl.focus();
                });
            });
        }
    }

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç –Æ–ò–ò –¢–∞—Ç—å—è–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    (function greetTatyana() {
        const greeting = `
            –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø <strong>–Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞</strong>, –≤–∞—à —é—Ä–∏—Å—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞.
            –ú–æ–≥—É –ø–æ–º–æ—á—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä, –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∂–∞–ª–æ–±—É –∏–ª–∏ –∏—Å–∫,
            –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã (PDF, Word, —Ñ–æ—Ç–æ, –∞—É–¥–∏–æ).
            <br><br>
            –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é: —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å, —Å –∫–µ–º –∏ –∫–æ–≥–¥–∞ ‚Äî –∏ —Å –∫–∞–∫–æ–π —Ü–µ–ª—å—é –≤—ã –æ–±—Ä–∞—â–∞–µ—Ç–µ—Å—å.
        `;
        addAiMessage(greeting, '<div class="chat__meta">–Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞ ¬∑ –ò–ò-—é—Ä–∏—Å—Ç</div>', true);
    })();

    // ===== –†–ê–ë–û–¢–ê –° –§–ê–ô–õ–ê–ú–ò =====
    function renderFilePanel() {
        filePanelErrorEl.textContent = "";
        filePanelFilesEl.innerHTML = "";

        if (!selectedFiles.length) {
            filePanelEl.hidden = true;
            return;
        }

        filePanelEl.hidden = false;

        selectedFiles.forEach(file => {
            let url = fileObjectUrls.get(file.name);
            if (!url) {
                url = URL.createObjectURL(file);
                fileObjectUrls.set(file.name, url);
            }

            const div = document.createElement("div");
            div.className = "file-panel__file";
            div.innerHTML = `
                <div>
                    <div class="file-panel__file-name">${file.name}</div>
                    <div class="list__meta">${(file.size / (1024 * 1024)).toFixed(2)} –ú–ë</div>
                </div>
                <div class="file-panel__links">
                    <a href="${url}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a>
                    <a href="${url}" download="${file.name}">–°–∫–∞—á–∞—Ç—å</a>
                </div>
            `;
            filePanelFilesEl.appendChild(div);
        });

        const goalText = (fileGoalEl.value || "").trim();
        fileAnalyzeBtn.disabled = !goalText || !selectedFiles.length;
    }

    if (fileInputEl) {
        fileInputEl.addEventListener("change", function () {
            selectedFiles = [];
            fileObjectUrls.forEach(url => URL.revokeObjectURL(url));
            fileObjectUrls.clear();
            filePanelErrorEl.textContent = "";

            const files = Array.from(fileInputEl.files || []);
            if (!files.length) {
                renderFilePanel();
                return;
            }

            if (files.length > 4) {
                filePanelErrorEl.textContent = "–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 4 —Ñ–∞–π–ª–æ–≤ –∑–∞ –æ–¥–∏–Ω –∞–Ω–∞–ª–∏–∑.";
                fileInputEl.value = "";
                renderFilePanel();
                return;
            }

            const MAX_SIZE = 30 * 1024 * 1024; // 30 –ú–ë
            for (const f of files) {
                if (f.size > MAX_SIZE) {
                    filePanelErrorEl.textContent = "–§–∞–π–ª \"" + f.name + "\" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 30 –ú–ë).";
                    fileInputEl.value = "";
                    renderFilePanel();
                    return;
                }
            }

            selectedFiles = files;
            renderFilePanel();
        });
    }

    if (fileGoalEl) {
        fileGoalEl.addEventListener("input", function () {
            const goalText = (fileGoalEl.value || "").trim();
            fileAnalyzeBtn.disabled = !goalText || !selectedFiles.length;
        });
    }

    if (chatAttachBtn && fileInputEl) {
        chatAttachBtn.addEventListener("click", function () {
            fileInputEl.click();
        });
    }

    document.querySelectorAll("#quick-actions-card .quick-actions__btn").forEach(btn => {
        btn.addEventListener("click", function () {
            const action = btn.getAttribute("data-action");
            if (!chatInputEl) return;

            if (action === "contract") {
                chatInputEl.value = "–ù—É–∂–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –¥–æ–≥–æ–≤–æ—Ä–∞. –°—Ç–æ—Ä–æ–Ω—ã, –ø—Ä–µ–¥–º–µ—Ç, —Å—Ä–æ–∫, —Ü–µ–Ω–∞ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å–¥–µ–ª–∫–∏ —Ç–∞–∫–∏–µ: ...";
            } else if (action === "complaint") {
                chatInputEl.value = "–ü–æ–º–æ–≥–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é –∂–∞–ª–æ–±—É. –û—Ä–≥–∞–Ω, –Ω–∞ —á—å–∏ –¥–µ–π—Å—Ç–≤–∏—è/–±–µ–∑–¥–µ–π—Å—Ç–≤–∏–µ –∂–∞–ª—É–µ–º—Å—è, –∏ —Å—É—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏—è: ...";
            } else if (action === "claim") {
                chatInputEl.value = "–ù—É–∂–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏—Å–∫–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ. –û—Ç–≤–µ—Ç—á–∏–∫, –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞: ...";
            } else if (action === "check-doc") {
                chatInputEl.value = "–ü—Ä–æ–≤–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –º–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–∫–æ–Ω—É. –û–ø–∏—Å–∞–Ω–∏–µ: ...";
            } else if (action === "analyze-files") {
                if (fileInputEl) fileInputEl.click();
            }
            chatInputEl.focus();
        });
    });

    if (fileAnalyzeBtn) {
        fileAnalyzeBtn.addEventListener("click", async function () {
            filePanelErrorEl.textContent = "";

            const goalText = (fileGoalEl.value || "").trim();
            if (!goalText) {
                filePanelErrorEl.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.";
                return;
            }
            if (!selectedFiles.length) {
                filePanelErrorEl.textContent = "–ù–µ –≤—ã–±—Ä–∞–Ω—ã —Ñ–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.";
                return;
            }

            fileAnalyzeBtn.disabled = true;
            fileAnalyzeBtn.textContent = "–ê–Ω–∞–ª–∏–∑...";

            try {
                const formData = new FormData();
                selectedFiles.forEach(f => {
                    formData.append("file", f);
                });
                formData.append("goal", goalText);
                formData.append("notes", goalText);
                formData.append("mode", "analyze_documents_with_laws");

                if (chatInputEl && chatInputEl.value.trim()) {
                    formData.append("context", chatInputEl.value.trim());
                }

                const res = await fetch("/consultations/upload", {
                    method: "POST",
                    credentials: "include",
                    body: formData
                });

                if (!res.ok) {
                    throw new Error("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " + res.status);
                }

                const data = await res.json();
                const answer = data.answer || "–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–µ –±—ã–ª –ø–æ–ª—É—á–µ–Ω.";
                const citations = Array.isArray(data.citations) ? data.citations : [];
                const problems = data.problems || null;
                const reasons = data.reasons || null;
                const suggestions = data.suggestions || null;

                let text = "";
                if (problems || reasons || suggestions) {
                    if (problems) text += "<strong>–ü—Ä–æ–±–ª–µ–º—ã / —Ä–∏—Å–∫–∏:</strong><br>" + problems + "<br><br>";
                    if (reasons) text += "<strong>–ü—Ä–∏—á–∏–Ω—ã / –Ω–∞ —á—Ç–æ —Å—Å—ã–ª–∞–µ—Ç—Å—è –∑–∞–∫–æ–Ω:</strong><br>" + reasons + "<br><br>";
                    if (suggestions) text += "<strong>–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</strong><br>" + suggestions + "<br><br>";
                    text += "<strong>–û–±—â–∏–π –≤—ã–≤–æ–¥ –Æ–ò–ò –¢–∞—Ç—å—è–Ω—ã:</strong><br>" + answer;
                } else {
                    text = answer;
                }

                let citationsHtml = "";
                if (citations.length) {
                    const ids = citations
                        .map(c => c.id || c.reference || "")
                        .filter(Boolean)
                        .join(", ");
                    citationsHtml = `
                        <div class="chat__meta">
                            –°—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –æ—Å–Ω–æ–≤–∞–Ω –æ—Ç–≤–µ—Ç: ${ids}
                        </div>
                    `;
                } else {
                    citationsHtml = `
                        <div class="chat__meta">
                            –í–Ω–∏–º–∞–Ω–∏–µ: –Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞ –Ω–µ —Å–º–æ–≥–ª–∞ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–æ—Ä–º—ã –∑–∞–∫–æ–Ω–∞. –û—Ç–≤–µ—Ç –Ω–µ–ª—å–∑—è —Å—á–∏—Ç–∞—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º.
                        </div>
                    `;
                }

                const fileNames = selectedFiles.map(f => f.name).join(", ");
                const header = `<strong>–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤:</strong> ${fileNames}<br><br>`;
                addAiMessage(header + text, citationsHtml, true);

                fileGoalEl.value = "";
                fileAnalyzeBtn.disabled = true;
                fileAnalyzeBtn.textContent = "üîç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏–∑";

            } catch (e) {
                console.error(e);
                filePanelErrorEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ü—Ä–∏—á–∏–Ω–∞: " +
                    (e && e.message ? e.message : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞") +
                    ". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç/–∫–∞—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–∞.";
                fileAnalyzeBtn.disabled = false;
                fileAnalyzeBtn.textContent = "üîç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏–∑";
            }
        });
    }

    // ===== –ú–û–ò –î–û–ö–£–ú–ï–ù–¢–´ =====
    async function loadRecentDocs() {
        const list = document.getElementById("docs-list");
        if (!list) return;
        list.innerHTML = '<li class="list__empty">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...</li>';

        try {
            const res = await fetch("/docs/documents?limit=5", { credentials: "include" });
            if (!res.ok) {
                list.innerHTML = '<li class="list__empty">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.</li>';
                return;
            }
            const data = await res.json();
            const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);

            if (!items.length) {
                list.innerHTML = '<li class="list__empty">–î–æ–∫—É–º–µ–Ω—Ç—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å.</li>';
                return;
            }

            list.innerHTML = "";
            items.forEach(doc => {
                const li = document.createElement("li");
                li.className = "list__item";

                const name = doc.name || doc.title || "–î–æ–∫—É–º–µ–Ω—Ç";
                const created = doc.created_at || "";
                const id = doc.id || doc.document_id || "";

                const viewUrl = id ? `/docs/documents/${id}/view` : null;
                const downloadUrl = id ? `/docs/documents/${id}/download` : null;

                li.innerHTML = `
                    <div class="list__title">${name}</div>
                    <div class="list__meta">${created}</div>
                `;

                const linksDiv = document.createElement("div");
                linksDiv.className = "file-panel__links";

                if (viewUrl) {
                    const aView = document.createElement("a");
                    aView.href = viewUrl;
                    aView.target = "_blank";
                    aView.textContent = "–û—Ç–∫—Ä—ã—Ç—å";
                    linksDiv.appendChild(aView);
                }

                if (downloadUrl) {
                    const aDownload = document.createElement("a");
                    aDownload.href = downloadUrl;
                    aDownload.textContent = "–°–∫–∞—á–∞—Ç—å";
                    linksDiv.appendChild(aDownload);
                }

                if (linksDiv.children.length) {
                    li.appendChild(linksDiv);
                }

                list.appendChild(li);
            });
        } catch (e) {
            console.error(e);
            list.innerHTML = '<li class="list__empty">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.</li>';
        }
    }

    // ===== –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ó–ê–ö–û–ù–û–í =====
    function computeDateRange(period) {
        const now = new Date();
        let from = new Date(now);
        let to = new Date(now);

        if (period === "7d") {
            from.setDate(now.getDate() - 6);
        } else if (period === "30d") {
            from.setDate(now.getDate() - 29);
        } else {
            from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            to = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }

        const toISO = (d) => d.toISOString().slice(0, 10);
        return { date_from: toISO(from), date_to: toISO(to) };
    }

    async function loadLaws() {
        const list = document.getElementById("laws-list");
        if (!list) return;
        list.innerHTML = '<li class="list__empty">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</li>';

        const country = document.getElementById("filter-country")?.value || "";
        const category = document.getElementById("filter-category")?.value || "";
        const period = document.getElementById("filter-period")?.value || "today";

        const range = computeDateRange(period);

        const params = new URLSearchParams();
        params.set("date_from", range.date_from);
        params.set("date_to", range.date_to);
        params.set("limit", "5");
        if (country) params.set("country", country);
        if (category) params.set("category", category);

        try {
            const res = await fetch("/legal-cases?" + params.toString(), { credentials: "include" });
            if (!res.ok) {
                list.innerHTML = '<li class="list__empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞.</li>';
                return;
            }
            const data = await res.json();
            const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);

            if (!items.length) {
                list.innerHTML = '<li class="list__empty">–ü–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</li>';
                return;
            }

            list.innerHTML = "";
            items.forEach(item => {
                const li = document.createElement("li");
                li.className = "list__item";
                li.innerHTML = `
                    <div class="list__title">${item.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</div>
                    <div class="list__meta">
                        ${item.document_type || "–ê–∫—Ç"}
                        ¬∑ ${item.country || country || ""}
                        ¬∑ ${item.category_name || item.category || ""}
                        ¬∑ ${item.date || ""}
                    </div>
                `;
                list.appendChild(li);
            });
        } catch (e) {
            console.error(e);
            list.innerHTML = '<li class="list__empty">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–∫–æ–Ω–∞–º.</li>';
        }
    }

    document.getElementById("filter-country")?.addEventListener("change", loadLaws);
    document.getElementById("filter-category")?.addEventListener("change", loadLaws);
    document.getElementById("filter-period")?.addEventListener("change", loadLaws);

    // ===== –ß–ê–¢ /ai/ask =====
    async function sendChatMessage() {
        if (!chatInputEl) return;
        const text = chatInputEl.value.trim();
        if (!text) return;

        addUserMessage(text);
        chatInputEl.value = "";
        chatInputEl.focus();

        showTypingIndicator();

        const country = document.getElementById("filter-country")?.value || "";
        const category = document.getElementById("filter-category")?.value || "";

        try {
            const payload = {
                query: text,
                country: country || null,
                category: category || null,
                // –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è –±—É–¥—É—â–µ–≥–æ "–∂–∏–≤–æ–≥–æ –º–æ–∑–≥–∞":
                mode: "dialog"
            };

            const res = await fetch("/ai/ask", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: "include",
                body: JSON.stringify(payload)
            });

            hideTypingIndicator();

            if (!res.ok) {
                addAiMessage(
                    "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –Æ–ò–ò –¢–∞—Ç—å—è–Ω—ã (–æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + res.status + "). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                    '<div class="chat__meta">–Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞ ¬∑ –ò–ò-—é—Ä–∏—Å—Ç</div>',
                    false
                );
                return;
            }

            const data = await res.json();
            const answer = data.answer || "–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, –Ω–æ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å.";
            const citations = Array.isArray(data.citations) ? data.citations : [];

            let citationsHtml = "";
            if (citations.length) {
                const ids = citations
                    .map(c => c.id || c.reference || "")
                    .filter(Boolean)
                    .join(", ");
                citationsHtml = `
                    <div class="chat__meta">
                        –°—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –æ—Å–Ω–æ–≤–∞–Ω –æ—Ç–≤–µ—Ç: ${ids}
                    </div>
                `;
            } else {
                citationsHtml = `
                    <div class="chat__meta">
                        –í–Ω–∏–º–∞–Ω–∏–µ: –Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞ –Ω–µ —Å–º–æ–≥–ª–∞ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–æ—Ä–º—ã –∑–∞–∫–æ–Ω–∞. –û—Ç–≤–µ—Ç –Ω–µ–ª—å–∑—è —Å—á–∏—Ç–∞—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º.
                    </div>
                `;
            }

            addAiMessage(answer, citationsHtml, true);
        } catch (e) {
            console.error(e);
            hideTypingIndicator();
            addAiMessage(
                "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –Æ–ò–ò –¢–∞—Ç—å—è–Ω—ã. –ü—Ä–∏—á–∏–Ω–∞: " +
                (e && e.message ? e.message : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞") +
                ". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                '<div class="chat__meta">–Æ–ò–ò –¢–∞—Ç—å—è–Ω–∞ ¬∑ –ò–ò-—é—Ä–∏—Å—Ç</div>',
                false
            );
        }
    }

    if (chatSendBtn) {
        chatSendBtn.addEventListener("click", sendChatMessage);
    }
    if (chatInputEl) {
        chatInputEl.addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });
    }

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
    loadRecentDocs();
    loadLaws();
</script>
</body>
</html>
