<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация — LegalAI</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #E7F1FF;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .card {
            background: white;
            width: 420px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0px 8px 24px rgba(0,0,0,0.15);
        }

        h1 {
            margin: 0 0 20px 0;
            font-size: 26px;
            text-align: center;
            color: #1A4C91;
        }

        label {
            font-size: 14px;
            color: #1A4C91;
            display: block;
        }

        input {
            width: 100%;
            padding: 10px 12px;
            margin-top: 6px;
            margin-bottom: 6px;
            border-radius: 10px;
            border: 1px solid #D2E3FF;
            font-size: 15px;
            box-sizing: border-box;
        }

        .hint {
            font-size: 12px;
            color: #6A6A6A;
            margin-bottom: 8px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #3A7AFE;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            background: #0053D6;
        }

        .link {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
            color: #1A4C91;
        }

        .link a {
            color: #3A7AFE;
            text-decoration: none;
            font-weight: bold;
        }

        .link a:hover {
            text-decoration: underline;
        }

        .terms {
            font-size: 12px;
            color: #4A4A4A;
        }

        .terms a {
            color: #3A7AFE;
            text-decoration: none;
        }

        .terms a:hover {
            text-decoration: underline;
        }

        .checkbox-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 10px;
        }

        .checkbox-row input[type="checkbox"] {
            margin-top: 3px;
        }

        .password-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .password-row input[type="password"],
        .password-row input[type="text"] {
            flex: 1;
            margin-bottom: 0;
        }

        .show-pass-label {
            font-size: 12px;
            white-space: nowrap;
            color: #1A4C91;
        }

        .error {
            color: #B3261E;
            font-size: 13px;
            margin-bottom: 8px;
        }
    </style>

</head>
<body>
    <div class="card">
        <h1>Регистрация</h1>

        <form id="register-form">
            <label>Фамилия</label>
            <input name="last_name" type="text" placeholder="Введите фамилию" required>

            <label>Имя</label>
            <input name="first_name" type="text" placeholder="Введите имя" required>

            <label>Отчество (при наличии)</label>
            <input name="middle_name" type="text" placeholder="Введите отчество (если есть)">

            <label>Год рождения</label>
            <input name="birth_year" type="number" min="1900" max="2100" placeholder="Например: 1975" required>

            <label>Email</label>
            <input name="email" type="email" placeholder="Ваш email" required>

            <label>Телефон</label>
            <input id="phone" name="phone" type="tel" placeholder="+7 900 000 00 00" required>

            <label>Подтвердите телефон</label>
            <input id="phone_confirm" name="phone_confirm" type="tel" placeholder="Повторите телефон" required>

            <label>Страна</label>
            <input name="country" type="text" placeholder="Страна" required>

            <label>Город / район</label>
            <input name="city" type="text" placeholder="Город или район" required>

            <label>Логин</label>
            <input name="username" type="text"
                   placeholder="Латинские буквы, цифры, точка, подчёркивание"
                   required>
            <div class="hint">
                Логин от 3 до 30 символов. Разрешены латинские буквы, цифры,
                точка и подчёркивание. Первый символ — буква.
                Примеры: <b>Admin777</b>, <b>legalai_user</b>.
            </div>

            <label>Пароль</label>
            <div class="password-row">
                <input id="password" name="password" type="password"
                       placeholder="Не менее 8 символов" required>
                <label class="show-pass-label">
                    <input type="checkbox" id="toggle-password">
                    Показать
                </label>
            </div>
            <div class="hint">
                Пароль от 8 до 64 символов, должен содержать:
                строчную букву, заглавную букву, цифру и спецсимвол
                (например: <b>LegalAI_2024!</b>).
            </div>

            <div id="error-message" class="error" style="display:none;"></div>

            <div class="checkbox-row">
                <input type="checkbox" id="agree" name="agree" required>
                <div class="terms">
                    Я подтверждаю, что ознакомился(ась) и согласен(на) со всеми условиями
                    и правилами сервиса LegalAI, а также с обработкой моих персональных данных.
                    <br>
                    <a href="/legal-notice.html" target="_blank">Правила и условия</a> •
                    <a href="/privacy.html" target="_blank">Политика конфиденциальности</a>
                </div>
            </div>

            <button type="submit">Создать аккаунт</button>
        </form>

        <div class="link">
            Уже есть аккаунт?
            <a href="/login">Войти</a>
        </div>
    </div>

    <script>
        // ==== Настройки API ====
        const API_BASE = window.LEGALAI_API_BASE || "https://api.legalai.su";
        const REGISTER_ENDPOINT =
            window.LEGALAI_REGISTER_ENDPOINT || (API_BASE + "/auth/register");

        // ==== Элементы формы ====
        const form = document.getElementById("register-form");
        const phone = document.getElementById("phone");
        const phoneConfirm = document.getElementById("phone_confirm");
        const passwordInput = document.getElementById("password");
        const togglePassword = document.getElementById("toggle-password");
        const errorBlock = document.getElementById("error-message");

        function showError(message) {
            errorBlock.textContent = message;
            errorBlock.style.display = "block";
        }

        function hideError() {
            errorBlock.textContent = "";
            errorBlock.style.display = "none";
        }

        // Показать / скрыть пароль
        togglePassword.addEventListener("change", function () {
            passwordInput.type = togglePassword.checked ? "text" : "password";
        });

        // Проверка логина по правилам варианта В
        function validateUsername(username) {
            // Латинская буква в начале, затем буквы/цифры/._, длина 3-30
            const re = /^[A-Za-z][A-Za-z0-9._]{2,29}$/;
            return re.test(username);
        }

        // Проверка пароля по правилам варианта В
        function validatePassword(password) {
            if (password.length < 8 || password.length > 64) {
                return false;
            }
            const hasLower = /[a-z]/.test(password);
            const hasUpper = /[A-Z]/.test(password);
            const hasDigit = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*()_\-+=[\]{};:"'\\|,.<>/?]/.test(password);
            return hasLower && hasUpper && hasDigit && hasSpecial;
        }

        form.addEventListener("submit", async function (e) {
            e.preventDefault();
            hideError();

            // 1) Телефон и подтверждение
            if (phone.value.trim() !== phoneConfirm.value.trim()) {
                showError("Телефон и подтверждение телефона не совпадают.");
                return;
            }

            const formData = new FormData(form);
            const username = (formData.get("username") || "").toString().trim();
            const email = (formData.get("email") || "").toString().trim();
            const password = (formData.get("password") || "").toString();

            if (!username || !email || !password) {
                showError("Логин, email и пароль обязательны для регистрации.");
                return;
            }

            // 2) Проверка логина
            if (!validateUsername(username)) {
                showError(
                    "Некорректный логин. Используйте латинские буквы, " +
                    "цифры, точку и подчёркивание. Длина от 3 до 30 символов, " +
                    "первый символ — буква."
                );
                return;
            }

            // 3) Проверка пароля
            if (!validatePassword(password)) {
                showError(
                    "Пароль должен быть от 8 до 64 символов и содержать " +
                    "строчную букву, заглавную букву, цифру и спецсимвол."
                );
                return;
            }

            // 4) Готовим payload, который реально ждёт backend
            const payload = {
                username,
                email,
                password
            };

            try {
                const response = await fetch(REGISTER_ENDPOINT, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    // Важно: БЕЗ credentials, иначе CORS на api.legalai.su может заблокировать
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Пытаемся достать detail из JSON (422 и т.п.)
                    let msg = `Не удалось создать аккаунт (код ${response.status}).`;

                    try {
                        const data = await response.json();
                        if (data && data.detail) {
                            if (Array.isArray(data.detail)) {
                                msg = data.detail
                                    .map((item) => {
                                        if (!item) return "";
                                        if (typeof item === "string") return item;
                                        return item.msg || item.message || "";
                                    })
                                    .filter(Boolean)
                                    .join("; ");
                            } else if (typeof data.detail === "string") {
                                msg = data.detail;
                            } else if (data.detail.message) {
                                msg = data.detail.message;
                            }
                        }
                    } catch (_) {
                        // если не JSON — пробуем текст
                        try {
                            const text = await response.text();
                            if (text) msg = text;
                        } catch (_) {}
                    }

                    showError(msg);
                    return;
                }

                // Успех -> редирект на страницу входа
                window.location.href = "/login";
            } catch (err) {
                console.error("Register error", err);
                showError(
                    "Возникла ошибка при обращении к серверу. Попробуйте позже."
                );
            }
        });
    </script>
</body>
</html>
